<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <title>Expense App</title>
</head>

<body>
    <div id="navbar-container"></div>
    <div class="container mt-4">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <form class="bg-primary p-3 rounded" id="form">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="amount" class="form-label text-black border-bottom border-dark">Amount
                                (₹)</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" id="amount" name="amount" class="form-control" required />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="description"
                                class="form-label text-black border-bottom border-dark">Description</label>
                            <input type="text" id="description" name="description" class="form-control" required />
                        </div>
                        <div class="col-md-4">
                            <label for="catogary"
                                class="form-label text-black border-bottom border-dark">Category</label>
                            <select id="catogary" class="form-select" name="catogary" required>
                                <option selected disabled>Select expense Category</option>
                                <option>Home</option>
                                <option>Fuel</option>
                                <option>Groceries</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-light" id="button" data-id="">Submit</button>
                </form>
            </div>
        </div>
    </div>
    <div class="container mt-4">
        <div class="table-container">
            <table id="userTable" class="table table table-dark table-borderless" style="background-color: #f0f8ff;">
                <thead class="blue-bg">
                    <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Description</th>
                        <th>Category</th>
                        <th></th>
                        <!-- You can add more headers if needed -->
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <!-- User data rows will be added here -->
                </tbody>
            </table>
        </div>
        <div class="pagination-controls text-center mt-4">
            <button id="prevPageButton" class="btn btn-primary">Previous</button>
            <span>Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
            <button id="nextPageButton" class="btn btn-primary">Next</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.5.0/axios.min.js"></script>
    <script>
        const form = document.querySelector('#form');
        const button = document.getElementById('button');
        let currentPage = 1;
        const itemsPerPage = 5;
        let data;

        form.addEventListener('submit', saveExpense);

        async function saveExpense(event) {
            event.preventDefault();
            const amount = event.target.amount.value;
            const description = event.target.description.value;
            const catogary = event.target.catogary.value;

            const expenseData = {
                amount,
                description,
                catogary,
            };

            try {
                const token = localStorage.getItem('token');
                const res = await axios.post('http://43.205.116.5:3553/expense/postexpense', expenseData, { headers: { "Authorization": token } });
                buttons(res.data);
            } catch (error) {
                console.error(error);
            }
        }
        function displayItemsForPage(data, page) {
            const startIdx = (page - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            const itemsToDisplay = data.slice(startIdx, endIdx);

            userTableBody.innerHTML = ''; // Clear existing table content

            itemsToDisplay.forEach((item) => {
                buttons(item);
            });
        }
        function updatePaginationControls(data) {
            const totalPages = Math.ceil(data.length / itemsPerPage);

            // You can customize the pagination controls as needed, e.g., previous/next buttons
            // For simplicity, I'm just updating the page number for this example
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
        }

        function buttons(responsedata) {
            const row = document.createElement('tr');

            const createdAtDate = new Date(responsedata.createdAt);
            const formattedDate = createdAtDate.toLocaleDateString();

            const dateCell = document.createElement('td');
            dateCell.textContent = formattedDate;
            row.appendChild(dateCell);

            const amountCell = document.createElement('td');
            amountCell.textContent = responsedata.amount;
            row.appendChild(amountCell);

            const descriptionCell = document.createElement('td');
            descriptionCell.textContent = responsedata.description;
            row.appendChild(descriptionCell);

            const categoryCell = document.createElement('td');
            categoryCell.textContent = responsedata.catogary;
            row.appendChild(categoryCell);

            // Declare actionCell before using it
            const actionCell = document.createElement('td');

            const deleteButton = document.createElement('button');
            deleteButton.className = 'btn btn-secondary';
            deleteButton.textContent = 'Delete';
            deleteButton.onclick = () => {
                const deleteid = responsedata.id;
                axios.delete(`http://43.205.116.5:3553/expense/deleteexpense/${deleteid}`)
                    .then((response) => {
                        console.log("deleted")
                    })
                    .catch((err) => {
                        console.log(err);
                    });
                userTableBody.removeChild(row);
            };

            actionCell.appendChild(deleteButton);
            row.appendChild(actionCell);

            // Append the row to the table body
            userTableBody.appendChild(row);
        }

        function parseJwt(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
        }


        // ... (Previous code)

        window.addEventListener("DOMContentLoaded", async () => {
            const token = localStorage.getItem('token');
            const decodedtoken = parseJwt(token);
            const navbarContainer = document.getElementById('navbar-container');
            const xhr = new XMLHttpRequest();

            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    navbarContainer.innerHTML = xhr.responseText;
                }
            };

            xhr.open("GET", "navbar.html", true);
            xhr.send();
            try {
                let res = await axios.get('http://43.205.116.5:3553/expense/getexpenses', { headers: { "Authorization": token } });
                data = res.data; // Assign data at this point

                // Calculate the total pages
                const totalPages = Math.ceil(data.length / itemsPerPage);
                updatePaginationControls(data, currentPage, totalPages);

                displayItemsForPage(data, currentPage, itemsPerPage);

                // Attach event listeners for pagination controls
                document.getElementById('nextPageButton').addEventListener('click', () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        displayItemsForPage(data, currentPage, itemsPerPage);
                        updatePaginationControls(data, currentPage, totalPages);
                    }
                });

                document.getElementById('prevPageButton').addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        displayItemsForPage(data, currentPage, itemsPerPage);
                        updatePaginationControls(data, currentPage, totalPages);
                    }
                });
            } catch (error) {
                console.log(error);
            }
        });

        // ... (The rest of your code)








        document.getElementById('nextPageButton').addEventListener('click', () => {
            const token = localStorage.getItem('token');
            const decodedtoken = parseJwt(token);
            const ispremiumuser = decodedtoken.ispremiumuser;

            if (currentPage < totalPages) {
                currentPage++;
                displayItemsForPage(data, currentPage);
                updatePaginationControls(data);
            }
        });

        document.getElementById('prevPageButton').addEventListener('click', () => {
            const token = localStorage.getItem('token');
            const decodedtoken = parseJwt(token);
            const ispremiumuser = decodedtoken.ispremiumuser;

            if (currentPage > 1) {
                currentPage--;
                displayItemsForPage(data, currentPage);
                updatePaginationControls(data);
            }
        });


    </script>
</body>

</html>